<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <link rel="stylesheet" type="text/css" href="fstyles.css">
</head>
<body>

    <nav>
        <ul>
            <li><a href="home.html">Home</a></li>
            <li><a href="foodstocks.html">Food Items</a></li>
            <li><a href="donatefood.html">Donate Food</a></li>
            <li><a href="contactus.html">Contact Us</a></li>
            <li><a href="checkout.html">Checkout (<span id="cart-count">0</span>)</a></li>
            <li id="auth-link"><a href="login.html">Login</a></li>
        </ul>
    </nav>
    <div class="header2">
        <span class="header-text">Checkout cart</span>
    </div>
    <script src="auth.js"></script> <!-- Include this in every page -->
    <section class="checkout-container">
        <h2>Cart Items</h2>
        <p id="message-box" class="hidden"></p>

        <table id="cart-table">
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Food Name</th>
                    <th>Quantity (In Plates)</th>
                    <th>Shelf Life (In Days)</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="cart-items">
                <tr><td colspan="5">No items in cart.</td></tr>
            </tbody>
        </table>

        <button class="confirm-btn" onclick="placeOrder()">Confirm Order</button>
        <button class="cancel-btn" onclick="clearCart()">Clear Cart</button>
    </section>

    <script>

        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem("cart")) || [];
            document.getElementById("cart-count").innerText = cart.length;
        }

        function showMessage(message, success = true) {
    const messageBox = document.getElementById("message-box");
    messageBox.innerText = message;
    messageBox.className = success ? "success-message" : "error-message";
    messageBox.classList.remove("hidden");
}


        function loadCart() {
    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    const cartTable = document.getElementById("cart-items");

    if (cart.length === 0) {
        cartTable.innerHTML = '<tr><td colspan="5">No items in cart.</td></tr>';
        return;
    }

    cartTable.innerHTML = cart.map((item, index) => `
        <tr>
            <td>${item.foodId}</td> <!-- Order ID from DB -->
            <td>${item.foodName}</td>
            <td>${item.foodQuantity}</td>
            <td>${item.foodShelfLife}</td>
            <td><button class="remove-btn" onclick="removeFromCart(${index})">Remove</button></td>
        </tr>
    `).join("");
}


        function removeFromCart(index) {
            let cart = JSON.parse(localStorage.getItem("cart")) || [];
            cart.splice(index, 1);
            localStorage.setItem("cart", JSON.stringify(cart));
            loadCart();
            updateCartCount();
            showMessage("Item removed from cart!");
        }

        async function placeOrder() {
    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    if (cart.length === 0) {
        showMessage("Cart is empty!", false);
        return;
    }

    let response = await fetch("http://localhost:5000/confirm-order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ cart })
    });

    let result = await response.json();
    console.log("Server Response:", result); // Debugging Line

    if (response.ok && result.success) {
        localStorage.removeItem("cart");
        loadCart();
        updateCartCount();
        showMessage(result.message, true); // Show success message in green
    } else {
        showMessage("Error: " + result.message, false); // Show error message in red
    }
}




        function clearCart() {
            localStorage.removeItem("cart");
            loadCart();
            updateCartCount();
            showMessage("Cart cleared!");
        }

        loadCart();
        updateCartCount();
    </script>

</body>
</html>
